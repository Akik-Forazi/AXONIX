<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>DevNet</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;0,600;1,400&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg:    #0a0a0c;
  --bg1:   #0f0f12;
  --bg2:   #141417;
  --bg3:   #1a1a1e;
  --bg4:   #212126;
  --bg5:   #29292f;
  --ln:    rgba(255,255,255,.06);
  --ln2:   rgba(255,255,255,.10);
  --ln3:   rgba(255,255,255,.16);
  --t0:    #ededf0;
  --t1:    #b8b9bf;
  --t2:    #7c7d85;
  --t3:    #4a4b52;
  --t4:    #2e2f35;
  --blue:  #5b8af0;
  --bld:   rgba(91,138,240,.14);
  --blg:   rgba(91,138,240,.07);
  --grn:   #38d47a;
  --gnd:   rgba(56,212,122,.13);
  --amb:   #f0a840;
  --amd:   rgba(240,168,64,.13);
  --red:   #e84545;
  --rdd:   rgba(232,69,69,.13);
  --pur:   #a47cf0;
  --prd:   rgba(164,124,240,.12);
  --mono:  'IBM Plex Mono', monospace;
  --sans:  'IBM Plex Sans', system-ui, sans-serif;
  --sb:    252px;
  --hh:    46px;
}
*,*::before,*::after { box-sizing: border-box; margin: 0; padding: 0; }
html,body { height:100%; background:var(--bg); color:var(--t0); font-family:var(--sans); font-size:13px; line-height:1.5; -webkit-font-smoothing:antialiased; overflow:hidden; }
::-webkit-scrollbar { width:3px; height:3px; }
::-webkit-scrollbar-thumb { background:var(--bg5); border-radius:2px; }
button,input,textarea,select { font-family:var(--sans); color:var(--t0); background:none; border:none; outline:none; cursor:pointer; }
input,textarea { cursor:text; }
a { color:var(--blue); text-decoration:none; }
a:hover { text-decoration:underline; }
code { font-family:var(--mono); }

/* ── GRID ────────────────────────────────────────────── */
#g {
  display:grid;
  grid-template-rows: var(--hh) 1fr;
  grid-template-columns: var(--sb) 1fr;
  height:100vh;
  transition: grid-template-columns .2s cubic-bezier(.4,0,.2,1);
}
#g.collapsed { grid-template-columns: 0 1fr; }

/* ── TOPBAR ──────────────────────────────────────────── */
#top {
  grid-column: 1/-1;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 12px; border-bottom:1px solid var(--ln);
  background:var(--bg1); z-index:20; gap:8px; flex-shrink:0;
}
.tl { display:flex; align-items:center; gap:8px; min-width:0; }
.tr { display:flex; align-items:center; gap:4px; flex-shrink:0; }

/* logo */
.brand {
  display:flex; align-items:center; gap:7px;
  padding-right:12px; border-right:1px solid var(--ln);
  height:100%; flex-shrink:0;
}
.bmark {
  width:22px; height:22px; border-radius:5px;
  background:linear-gradient(135deg,var(--blue),var(--pur));
  display:flex; align-items:center; justify-content:center;
  font-family:var(--mono); font-size:9px; font-weight:600; color:#fff;
  box-shadow:0 1px 6px rgba(91,138,240,.4); flex-shrink:0;
}
.bname { font-size:13px; font-weight:600; letter-spacing:-.2px; }
.bsub  { font-size:9px; font-family:var(--mono); color:var(--t3); letter-spacing:.3px; }

/* model pill */
.mpill {
  display:flex; align-items:center; gap:5px;
  padding:3px 9px; border-radius:5px;
  border:1px solid var(--ln); background:var(--bg2);
  font-size:11px; font-family:var(--mono); color:var(--t2);
  margin-left:6px;
}
.mpill-dot { width:5px; height:5px; border-radius:50%; background:var(--t4); transition:all .3s; flex-shrink:0; }
.mpill-dot.on   { background:var(--grn); box-shadow:0 0 0 3px rgba(56,212,122,.2); }
.mpill-dot.off  { background:var(--red); }
.mpill-dot.busy { background:var(--amb); animation:pulse .8s ease infinite; }

/* mode pills */
.modes {
  display:flex; gap:1px; background:var(--bg2);
  border:1px solid var(--ln); border-radius:6px; padding:2px;
}
.mb {
  padding:3px 10px; border-radius:4px;
  font-size:11px; font-weight:500; color:var(--t3);
  border:1px solid transparent; transition:all .1s;
}
.mb:hover { color:var(--t1); }
.mb.on { background:var(--bg4); color:var(--t0); border-color:var(--ln2); }
.mb.on[data-m="agent"] { color:var(--blue); }
.mb.on[data-m="goal"]  { color:var(--pur); }

/* icon & text buttons */
.ib {
  width:28px; height:28px; border-radius:5px;
  border:1px solid var(--ln); background:var(--bg2); color:var(--t3);
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
  transition:all .1s;
}
.ib:hover { border-color:var(--ln2); color:var(--t1); background:var(--bg3); }
.ib svg { width:12px; height:12px; stroke:currentColor; stroke-width:1.6; fill:none; stroke-linecap:round; stroke-linejoin:round; }
.tb {
  height:26px; padding:0 9px; border-radius:5px;
  border:1px solid var(--ln); background:var(--bg2);
  color:var(--t2); font-size:11px; font-weight:500;
  display:flex; align-items:center; gap:4px; flex-shrink:0;
  transition:all .1s;
}
.tb:hover { border-color:var(--ln2); color:var(--t0); background:var(--bg3); }
.tb svg { width:10px; height:10px; stroke:currentColor; stroke-width:1.7; fill:none; stroke-linecap:round; }
.vs { width:1px; height:14px; background:var(--ln); margin:0 1px; flex-shrink:0; }

/* ── SIDEBAR ─────────────────────────────────────────── */
#sb {
  border-right:1px solid var(--ln);
  display:flex; flex-direction:column;
  background:var(--bg1); overflow:hidden;
  width:var(--sb); transition:width .2s;
}
#g.collapsed #sb { width:0; min-width:0; }

.sb-tabs { display:flex; border-bottom:1px solid var(--ln); flex-shrink:0; }
.st {
  flex:1; padding:7px 0; text-align:center;
  font-size:9.5px; font-family:var(--mono); font-weight:500;
  letter-spacing:.7px; text-transform:uppercase;
  color:var(--t3); cursor:pointer;
  border-bottom:1.5px solid transparent; transition:all .1s;
}
.st:hover { color:var(--t1); background:var(--bg2); }
.st.on { color:var(--t0); border-bottom-color:var(--blue); }

.sp { flex:1; overflow:hidden; display:none; flex-direction:column; }
.sp.on { display:flex; }

/* sb sections */
.sbs { padding:9px 11px; border-bottom:1px solid var(--ln); flex-shrink:0; }
.sbl {
  font-size:9px; font-weight:600; letter-spacing:.8px;
  text-transform:uppercase; color:var(--t3);
  margin-bottom:6px; display:flex; align-items:center; justify-content:space-between;
}
.sba { font-size:10px; color:var(--t3); padding:1px 4px; border-radius:3px; transition:all .08s; }
.sba:hover { background:var(--bg3); color:var(--t1); }

.kv { display:flex; justify-content:space-between; align-items:center; padding:1.5px 0; }
.kk { font-size:10px; font-family:var(--mono); color:var(--t3); }
.kv_ {
  font-size:10px; font-family:var(--mono); color:var(--t1);
  max-width:138px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
.kv_.on { color:var(--grn); } .kv_.off { color:var(--red); } .kv_.warn { color:var(--amb); }

/* tool list */
.tl-wrap { flex:1; overflow-y:auto; padding:3px 0; }
.tli {
  display:flex; align-items:center; gap:6px;
  padding:2.5px 11px; transition:background .07s;
}
.tli:hover { background:var(--bg3); }
.tld { width:3px; height:3px; border-radius:50%; background:var(--t4); flex-shrink:0; transition:background .1s; }
.tli:hover .tld { background:var(--blue); }
.tln { font-size:10px; font-family:var(--mono); color:var(--t2); }

/* memory */
.mw { padding:7px 11px; border-top:1px solid var(--ln); flex-shrink:0; }
.ml { margin-top:4px; display:flex; flex-direction:column; gap:2px; max-height:64px; overflow-y:auto; }
.me { font-size:10px; font-family:var(--mono); color:var(--t3); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.me b { color:var(--pur); font-weight:500; }
.me-empty { font-size:10px; font-family:var(--mono); color:var(--t4); font-style:italic; }

/* sb footer */
.sbf { display:flex; gap:3px; padding:7px 9px; border-top:1px solid var(--ln); flex-shrink:0; }
.sfb {
  flex:1; padding:4px; font-size:10px; font-family:var(--mono);
  background:var(--bg2); border:1px solid var(--ln);
  color:var(--t3); border-radius:5px; transition:all .1s; text-align:center;
}
.sfb:hover { border-color:var(--ln2); color:var(--t1); }
.sfb.d:hover { border-color:rgba(232,69,69,.3); color:var(--red); }

/* file tree */
.ftree { flex:1; overflow-y:auto; padding:3px 0; }
.ftr {
  display:flex; align-items:center; gap:5px;
  padding:2px 11px; cursor:pointer;
  font-family:var(--mono); font-size:10.5px; color:var(--t3);
  white-space:nowrap; overflow:hidden; transition:background .07s;
}
.ftr:hover { background:var(--bg3); color:var(--t1); }
.ftico { font-size:9px; flex-shrink:0; width:13px; text-align:center; }

/* ── MAIN ────────────────────────────────────────────── */
#main { display:flex; flex-direction:column; overflow:hidden; background:var(--bg); position:relative; }

/* ── FEED ────────────────────────────────────────────── */
#feed { flex:1; overflow-y:auto; display:flex; flex-direction:column; padding-bottom:6px; }

/* welcome */
.wlc {
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  padding:56px 28px; gap:20px; text-align:center;
}
.wico {
  width:48px; height:48px; border-radius:10px;
  background:linear-gradient(135deg,rgba(91,138,240,.12),rgba(164,124,240,.10));
  border:1px solid rgba(91,138,240,.18);
  display:flex; align-items:center; justify-content:center;
  font-family:var(--mono); font-size:18px; font-weight:600; color:var(--blue);
}
.wh { font-size:20px; font-weight:600; letter-spacing:-.4px; }
.wh em { color:var(--t2); font-style:normal; font-weight:300; }
.wp { font-size:13px; color:var(--t2); max-width:340px; line-height:1.75; }
.chips { display:flex; flex-wrap:wrap; gap:5px; justify-content:center; max-width:460px; }
.chip {
  padding:4px 12px; border-radius:20px;
  border:1px solid var(--ln2); background:var(--bg2);
  font-size:11px; color:var(--t2); cursor:pointer;
  transition:all .12s;
}
.chip:hover { border-color:var(--blue); color:var(--blue); background:var(--blg); transform:translateY(-1px); }

/* messages */
.msg {
  padding:13px 18px;
  border-bottom:1px solid var(--ln);
  animation:fadeup .14s ease;
}
@keyframes fadeup { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }
.mh { display:flex; align-items:center; gap:6px; margin-bottom:4px; }
.av {
  width:18px; height:18px; border-radius:3px;
  font-family:var(--mono); font-size:7.5px; font-weight:600;
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
}
.av-u { background:var(--bld); border:1px solid rgba(91,138,240,.22); color:var(--blue); }
.av-a { background:var(--bg4); border:1px solid var(--ln2); color:var(--t3); }
.mwho { font-size:11px; font-weight:600; color:var(--t1); }
.mts  { font-size:10px; font-family:var(--mono); color:var(--t4); margin-left:auto; }

.mb { padding-left:24px; font-size:13.5px; line-height:1.78; color:var(--t0); }
.mb p { margin-bottom:7px; } .mb p:last-child { margin-bottom:0; }
.mb strong { color:var(--t0); font-weight:600; }
.mb em { color:var(--t2); }
.mb code { font-family:var(--mono); font-size:11.5px; background:var(--bg3); border:1px solid var(--ln2); border-radius:3px; padding:1px 5px; color:var(--pur); }
.mb a { color:var(--blue); }
.mb ul,.mb ol { padding-left:20px; margin-bottom:7px; }
.mb li { margin-bottom:3px; }

/* cursor */
.cr { display:inline-block; width:1.5px; height:13px; background:var(--t1); vertical-align:middle; animation:blink .85s step-end infinite; margin-left:1px; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

/* code block */
.cb { margin:8px 0; border-radius:7px; overflow:hidden; border:1px solid var(--ln); }
.cbt { display:flex; align-items:center; justify-content:space-between; padding:5px 10px; background:var(--bg3); border-bottom:1px solid var(--ln); }
.cbl { font-size:9px; font-family:var(--mono); color:var(--t3); letter-spacing:.5px; text-transform:uppercase; }
.cbc { font-size:10px; font-family:var(--mono); color:var(--t3); border:1px solid var(--ln); padding:1px 7px; border-radius:3px; transition:all .1s; }
.cbc:hover { border-color:var(--ln2); color:var(--t1); }
.cb pre { padding:11px; background:var(--bg2); overflow-x:auto; font-size:12px; font-family:var(--mono); line-height:1.65; color:#d0d3de; margin:0; }

/* tool calls */
.tcl { padding-left:24px; display:flex; flex-direction:column; gap:3px; margin:4px 0; }
.tc { border:1px solid var(--ln); border-radius:6px; overflow:hidden; transition:border-color .1s; }
.tc:hover { border-color:var(--ln2); }
.tch { display:flex; align-items:center; gap:5px; padding:5px 9px; cursor:pointer; background:var(--bg2); transition:background .07s; user-select:none; }
.tch:hover { background:var(--bg3); }
.tcb_ { width:13px; height:13px; border-radius:3px; display:flex; align-items:center; justify-content:center; font-size:7px; flex-shrink:0; font-family:var(--mono); transition:all .12s; }
.tcb_.pend { background:var(--bld); border:1px solid rgba(91,138,240,.18); color:var(--blue); }
.tcb_.ok   { background:var(--gnd); border:1px solid rgba(56,212,122,.2); color:var(--grn); }
.tcb_.er   { background:var(--rdd); border:1px solid rgba(232,69,69,.2);  color:var(--red); }
.tct { font-size:11px; font-family:var(--mono); color:var(--blue); font-weight:500; transition:color .1s; }
.tct.ok { color:var(--grn); } .tct.er { color:var(--red); }
.tcs_ { margin-left:auto; font-size:9px; font-family:var(--mono); color:var(--t4); }
.tcarr { font-size:8px; color:var(--t4); margin-left:2px; transition:transform .14s; }
.tcarr.open { transform:rotate(90deg); }
.tcbody { display:none; padding:8px 10px; font-size:11px; font-family:var(--mono); color:var(--t1); white-space:pre-wrap; background:var(--bg1); border-top:1px solid var(--ln); max-height:200px; overflow-y:auto; line-height:1.6; }
.tcbody.open { display:block; }
.tcsec { color:var(--t4); font-size:9.5px; margin:4px 0 2px; display:block; }

/* step info */
.sr { padding-left:24px; display:flex; gap:4px; flex-wrap:wrap; margin:3px 0; }
.stag { font-size:10px; font-family:var(--mono); color:var(--t3); background:var(--bg3); border:1px solid var(--ln); border-radius:9px; padding:1px 7px; }

/* thinking */
.thinking { padding:11px 18px; display:flex; align-items:center; gap:7px; border-bottom:1px solid var(--ln); }
.thav { width:18px; height:18px; border-radius:3px; background:var(--bg4); border:1px solid var(--ln2); display:flex; align-items:center; justify-content:center; font-family:var(--mono); font-size:7.5px; color:var(--t3); }
.thtxt { font-size:12px; color:var(--t3); }
.dots span { display:inline-block; width:3px; height:3px; border-radius:50%; background:var(--t3); margin:0 2px; animation:db 1.4s ease-in-out infinite; }
.dots span:nth-child(2){animation-delay:.2s}.dots span:nth-child(3){animation-delay:.4s}
@keyframes db{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}

/* ── INPUT ───────────────────────────────────────────── */
.inpw { padding:9px 14px 13px; flex-shrink:0; }
.inpbox {
  border:1px solid var(--ln2); border-radius:10px;
  background:var(--bg2); max-width:700px; margin:0 auto;
  transition:border-color .16s, box-shadow .16s; overflow:hidden;
}
.inpbox:focus-within { border-color:rgba(255,255,255,.11); box-shadow:0 0 0 3px rgba(255,255,255,.02),0 4px 18px rgba(0,0,0,.28); }
.inptop { display:flex; align-items:flex-end; gap:7px; padding:10px 12px 8px; }
#inp {
  flex:1; background:none; border:none; outline:none;
  color:var(--t0); font-size:13.5px; resize:none;
  min-height:22px; max-height:150px; line-height:1.6;
}
#inp::placeholder { color:var(--t3); }
.inpsend {
  width:28px; height:28px; border-radius:6px;
  background:var(--t0); border:none; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  flex-shrink:0; transition:all .1s; opacity:.82;
}
.inpsend:hover { opacity:1; transform:scale(1.04); }
.inpsend:disabled { opacity:.15; cursor:not-allowed; transform:none; }
.inpsend svg { width:11px; height:11px; fill:var(--bg); }
.inpbot { display:flex; align-items:center; justify-content:space-between; padding:0 12px 7px; }
.inpmode { display:flex; align-items:center; gap:4px; font-size:10px; font-family:var(--mono); color:var(--t3); }
.mpip { width:4px; height:4px; border-radius:50%; background:var(--t4); }
.mpip.agent { background:var(--blue); box-shadow:0 0 4px rgba(91,138,240,.5); }
.mpip.goal  { background:var(--pur);  box-shadow:0 0 4px rgba(164,124,240,.5); }
.inptip { font-size:10px; font-family:var(--mono); color:var(--t4); }
.inptip kbd { display:inline-block; padding:0 3px; border:1px solid var(--ln2); border-radius:2px; background:var(--bg1); font-size:9px; font-family:var(--mono); color:var(--t3); }

/* ── OVERLAY / PANELS ────────────────────────────────── */
#ov {
  position:absolute; inset:0; background:rgba(0,0,0,.65);
  backdrop-filter:blur(8px); z-index:40;
  display:none; align-items:flex-start; justify-content:center;
  padding-top:44px;
}
#ov.open { display:flex; }
.pan {
  background:var(--bg1); border:1px solid var(--ln2);
  border-radius:13px; width:100%; max-width:580px;
  max-height:calc(100vh - 76px); overflow-y:auto;
  animation:pin .14s ease;
}
@keyframes pin { from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:none} }
.pnh { display:flex; align-items:flex-start; justify-content:space-between; padding:15px 18px 11px; border-bottom:1px solid var(--ln); position:sticky; top:0; background:var(--bg1); z-index:1; }
.pnt { font-size:14px; font-weight:600; letter-spacing:-.3px; }
.pns { font-size:11px; color:var(--t3); margin-top:2px; }
.pnx { width:24px; height:24px; border-radius:4px; border:1px solid var(--ln); color:var(--t3); display:flex; align-items:center; justify-content:center; font-size:13px; transition:all .1s; flex-shrink:0; }
.pnx:hover { border-color:var(--ln2); color:var(--t0); }
.pnb { padding:16px 18px; display:flex; flex-direction:column; gap:14px; }

.fsec { font-size:9px; font-weight:600; letter-spacing:.8px; text-transform:uppercase; color:var(--t3); padding-bottom:4px; border-bottom:1px solid var(--ln); }
.field { display:flex; flex-direction:column; gap:3px; }
.flbl { font-size:11px; font-weight:600; color:var(--t1); }
.fhnt { font-size:10px; color:var(--t3); }
.field input,.field select { background:var(--bg2); border:1px solid var(--ln2); border-radius:6px; padding:6px 10px; color:var(--t0); font-size:12px; transition:border-color .12s; }
.field input:focus,.field select:focus { border-color:var(--blue); }
.frow { display:grid; grid-template-columns:1fr 1fr; gap:9px; }
.range-row { display:flex; align-items:center; gap:9px; }
.range-row input[type=range] { flex:1; -webkit-appearance:none; height:2px; background:var(--bg4); border-radius:2px; border:none; outline:none; }
.range-row input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:12px; height:12px; background:var(--blue); border-radius:50%; cursor:pointer; }
.rv { font-size:11px; font-family:var(--mono); color:var(--t1); min-width:28px; text-align:right; }
.icard { background:var(--bg2); border:1px solid var(--ln); border-radius:6px; padding:10px 12px; font-size:11px; color:var(--t2); line-height:1.8; }
.icard code { font-family:var(--mono); font-size:10px; background:var(--bg0); border:1px solid var(--ln); border-radius:2px; padding:0 4px; color:var(--pur); }
.icard b { color:var(--t0); }
.br { display:flex; gap:6px; justify-content:flex-end; }
.bp { padding:6px 16px; background:var(--blue); border:none; border-radius:6px; color:#fff; font-size:12px; font-weight:600; transition:all .1s; }
.bp:hover { background:#4a79e0; }
.bg { padding:6px 16px; background:var(--bg2); border:1px solid var(--ln2); border-radius:6px; color:var(--t1); font-size:12px; transition:all .1s; }
.bg:hover { border-color:var(--ln3); color:var(--t0); }

/* model list */
.mlist { display:flex; flex-direction:column; gap:5px; }
.mc { background:var(--bg2); border:1px solid var(--ln); border-radius:8px; padding:10px 12px; position:relative; transition:border-color .1s; }
.mc:hover { border-color:var(--ln2); }
.mc.active { border-color:rgba(91,138,240,.32); background:var(--blg); }
.mcat { position:absolute; top:8px; right:10px; font-size:8px; font-family:var(--mono); font-weight:600; letter-spacing:.4px; text-transform:uppercase; color:var(--blue); }
.mcn { font-size:12px; font-weight:700; color:var(--t0); margin-bottom:2px; }
.mcd { font-size:11px; color:var(--t2); line-height:1.5; margin-bottom:6px; }
.mctags { display:flex; flex-wrap:wrap; gap:3px; margin-bottom:7px; }
.mtag { font-size:9px; font-family:var(--mono); padding:1px 5px; border-radius:8px; background:var(--bg4); border:1px solid var(--ln); color:var(--t3); }
.mtag.dl  { background:var(--gnd); border-color:rgba(56,212,122,.2); color:var(--grn); }
.mtag.ndl { background:var(--amd); border-color:rgba(240,168,64,.2); color:var(--amb); }
.mtag.reg { background:var(--bld); border-color:rgba(91,138,240,.2); color:var(--blue); }
.mtag.rec { background:var(--prd); border-color:rgba(164,124,240,.2); color:var(--pur); }
.macts { display:flex; gap:4px; flex-wrap:wrap; }
.mbtn { padding:3px 10px; border-radius:4px; font-size:10.5px; font-weight:500; border:1px solid var(--ln2); background:var(--bg3); color:var(--t2); transition:all .09s; }
.mbtn:hover { border-color:var(--ln3); color:var(--t0); }
.mbtn.use { background:var(--bld); border-color:rgba(91,138,240,.25); color:var(--blue); }
.mbtn.use:hover { background:rgba(91,138,240,.2); }
.mghdr { font-size:9.5px; font-weight:600; letter-spacing:.5px; text-transform:uppercase; color:var(--t3); padding:7px 0 4px; border-top:1px solid var(--ln); margin-top:3px; }
.mghdr:first-child { border-top:none; padding-top:0; }

/* toast */
#toast { position:fixed; bottom:16px; left:50%; transform:translateX(-50%) translateY(6px); background:var(--bg3); border:1px solid var(--ln2); border-radius:6px; padding:5px 13px; font-size:11px; font-family:var(--mono); color:var(--t1); opacity:0; pointer-events:none; z-index:999; transition:all .18s; white-space:nowrap; }
#toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
#toast.ok  { border-color:rgba(56,212,122,.3); color:var(--grn); }
#toast.err { border-color:rgba(232,69,69,.3); color:var(--red); }

.spin { display:inline-block; width:10px; height:10px; border:1.5px solid var(--ln2); border-top-color:var(--blue); border-radius:50%; animation:sp .6s linear infinite; vertical-align:middle; }
@keyframes sp { to{transform:rotate(360deg)} }
@keyframes pulse { 0%,100%{opacity:1}50%{opacity:.4} }
</style>
</head>
<body>
<div id="g">

<!-- ══ TOPBAR ══════════════════════════════════════════ -->
<header id="top">
  <div class="tl">
    <button class="ib" onclick="toggleSb()" title="Sidebar">
      <svg viewBox="0 0 12 12"><path d="M1 3h10M1 6h10M1 9h10"/></svg>
    </button>
    <div class="brand">
      <div class="bmark">DN</div>
      <div><div class="bname">DevNet</div><div class="bsub">local agent</div></div>
    </div>
    <div class="mpill">
      <div class="mpill-dot" id="liveDot"></div>
      <span id="hMdl">—</span>
    </div>
  </div>

  <div class="modes">
    <button class="mb on" data-m="chat"  onclick="setMode('chat')">Chat</button>
    <button class="mb"    data-m="agent" onclick="setMode('agent')">Agent</button>
    <button class="mb"    data-m="goal"  onclick="setMode('goal')">Goal</button>
  </div>

  <div class="tr">
    <button class="tb" onclick="openPanel('models')">
      <svg viewBox="0 0 12 12"><rect x="1" y="1" width="4" height="4" rx="1"/><rect x="7" y="1" width="4" height="4" rx="1"/><rect x="1" y="7" width="4" height="4" rx="1"/><rect x="7" y="7" width="4" height="4" rx="1"/></svg>
      Models
    </button>
    <button class="tb" onclick="openPanel('settings')">
      <svg viewBox="0 0 12 12"><circle cx="6" cy="6" r="1.5"/><path d="M6 1v2M6 9v2M1 6h2M9 6h2M2.5 2.5l1.4 1.4M8.1 8.1l1.4 1.4M2.5 9.5l1.4-1.4M8.1 3.9l1.4-1.4"/></svg>
      Settings
    </button>
    <div class="vs"></div>
    <button class="tb" onclick="newChat()">
      <svg viewBox="0 0 12 12"><path d="M6 2v8M2 6h8"/></svg>
      New
    </button>
  </div>
</header>

<!-- ══ SIDEBAR ═════════════════════════════════════════ -->
<aside id="sb">
  <div class="sb-tabs">
    <div class="st on" id="stInfo"  onclick="sbTab('info')">INFO</div>
    <div class="st"    id="stFiles" onclick="sbTab('files')">FILES</div>
    <div class="st"    id="stHist"  onclick="sbTab('hist')">HIST</div>
  </div>

  <!-- INFO pane -->
  <div class="sp on" id="spInfo">
    <div class="sbs">
      <div class="sbl">Connection</div>
      <div class="kv"><span class="kk">status</span><span class="kv_ " id="sbSt">—</span></div>
      <div class="kv"><span class="kk">model</span><span class="kv_" id="sbMdl">—</span></div>
      <div class="kv"><span class="kk">url</span><span class="kv_" id="sbUrl">—</span></div>
      <div class="kv"><span class="kk">turns</span><span class="kv_" id="sbTurns">0</span></div>
    </div>
    <div class="sbs" style="padding-bottom:3px">
      <div class="sbl">Tools <span style="color:var(--t4)">18</span></div>
    </div>
    <div class="tl-wrap">
      <div class="tli"><div class="tld"></div><span class="tln">file_read / write / edit / append</span></div>
      <div class="tli"><div class="tld"></div><span class="tln">file_delete / list / search</span></div>
      <div class="tli"><div class="tld"></div><span class="tln">shell_run / shell_python</span></div>
      <div class="tli"><div class="tld"></div><span class="tln">web_get / web_search</span></div>
      <div class="tli"><div class="tld"></div><span class="tln">code_lint / format / tree</span></div>
      <div class="tli"><div class="tld"></div><span class="tln">memory_save / get / list</span></div>
      <div class="tli"><div class="tld"></div><span class="tln">done</span></div>
    </div>
    <div class="mw">
      <div class="sbl">Memory <button class="sba" onclick="loadMem()">↺</button></div>
      <div class="ml" id="memList"><span class="me-empty">empty</span></div>
    </div>
    <div class="sbf">
      <button class="sfb" onclick="openPanel('settings')">Settings</button>
      <button class="sfb d" onclick="clearMem()">Clear mem</button>
    </div>
  </div>

  <!-- FILES pane -->
  <div class="sp" id="spFiles">
    <div class="sbs">
      <div class="sbl">Workspace <button class="sba" onclick="loadFiles()">↺</button></div>
    </div>
    <div class="ftree" id="fileTree"></div>
  </div>

  <!-- HISTORY pane -->
  <div class="sp" id="spHist">
    <div class="sbs">
      <div class="sbl">Sessions <button class="sba" onclick="loadSess()">↺</button></div>
    </div>
    <div class="ftree" id="sessList"></div>
  </div>
</aside>

<!-- ══ MAIN ════════════════════════════════════════════ -->
<main id="main">
  <div id="feed">
    <div class="wlc" id="welcome">
      <div class="wico">◈</div>
      <div class="wh">DevNet <em>Agent</em></div>
      <p class="wp">Fully local AI running on Ollama. Use <strong>Agent</strong> mode for autonomous task execution with tools.</p>
      <div class="chips">
        <div class="chip" onclick="chip(this)">Build a FastAPI REST API</div>
        <div class="chip" onclick="chip(this)">Read &amp; summarize this project</div>
        <div class="chip" onclick="chip(this)">Write unit tests for my code</div>
        <div class="chip" onclick="chip(this)">Search web for Python news</div>
        <div class="chip" onclick="chip(this)">Create a CLI tool in Python</div>
        <div class="chip" onclick="chip(this)">Find all TODOs in codebase</div>
      </div>
    </div>
  </div>

  <div class="inpw">
    <div class="inpbox">
      <div class="inptop">
        <textarea id="inp" placeholder="Message DevNet…" rows="1"
          onkeydown="onKey(event)" oninput="grow(this)"></textarea>
        <button class="inpsend" id="sendBtn" onclick="send()">
          <svg viewBox="0 0 12 12"><path d="M11 6L1 1l2.5 5L1 11l10-5z"/></svg>
        </button>
      </div>
      <div class="inpbot">
        <div class="inpmode"><div class="mpip" id="mPip"></div><span id="mLbl">chat</span></div>
        <div class="inptip"><kbd>↵</kbd> send &nbsp;<kbd>⇧↵</kbd> newline</div>
      </div>
    </div>
  </div>

  <!-- OVERLAY -->
  <div id="ov" onclick="ovBg(event)">

    <!-- Settings -->
    <div class="pan" id="panSettings" style="display:none" onclick="event.stopPropagation()">
      <div class="pnh">
        <div><div class="pnt">Settings</div><div class="pns">Connection &amp; generation</div></div>
        <button class="pnx" onclick="closeAll()">✕</button>
      </div>
      <div class="pnb">
        <div class="fsec">Connection</div>
        <div class="field">
          <label class="flbl">Ollama URL</label>
          <input id="cfgUrl" type="text" placeholder="http://localhost:11434"/>
          <div class="fhnt">Must have Ollama running: <code>ollama serve</code></div>
        </div>
        <div class="field">
          <label class="flbl">Model name</label>
          <input id="cfgModel" type="text" placeholder="gemma3-4b"/>
          <div class="fhnt">Must be imported via <code>devnet setup</code></div>
        </div>
        <div class="fsec">Generation</div>
        <div class="frow">
          <div class="field"><label class="flbl">Max steps</label><input id="cfgSteps" type="number" min="1" max="100"/></div>
          <div class="field"><label class="flbl">Max tokens</label><input id="cfgTokens" type="number" min="256" max="32768"/></div>
        </div>
        <div class="field">
          <label class="flbl">Temperature — <span id="tDisp">0.2</span></label>
          <div class="range-row">
            <input type="range" id="cfgTemp" min="0" max="2" step="0.05" value="0.2"
              oninput="tDisp.textContent=parseFloat(this.value).toFixed(2)"/>
            <span class="rv" id="tDisp2">0.2</span>
          </div>
          <div class="fhnt">0 = deterministic · 2 = creative</div>
        </div>
        <div class="fsec">Paths</div>
        <div class="icard" id="pathInfo">—</div>
        <div class="br">
          <button class="bg" onclick="closeAll()">Cancel</button>
          <button class="bp" onclick="saveSettings()">Save settings</button>
        </div>
      </div>
    </div>

    <!-- Models -->
    <div class="pan" id="panModels" style="display:none" onclick="event.stopPropagation()">
      <div class="pnh">
        <div><div class="pnt">Model Manager</div><div class="pns">Switch · browse · import via devnet setup</div></div>
        <button class="pnx" onclick="closeAll()">✕</button>
      </div>
      <div class="pnb">
        <div class="icard">
          Run <code>devnet setup</code> to import all GGUFs from <code>~/.devnet/models/</code> into Ollama, then switch here.
          Or run <code>ollama pull &lt;model&gt;</code> to pull directly from Ollama registry.
        </div>
        <div class="mlist" id="modelList">
          <div style="color:var(--t3);padding:14px;text-align:center;font-family:var(--mono);font-size:11px">Loading…</div>
        </div>
      </div>
    </div>

  </div>
</main>
</div>
<div id="toast"></div>

<script>
// ═══════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════
let mode  = 'chat';
let busy  = false;
let turns = 0;
let cbIdx = 0;
let cfg   = {};

// ═══════════════════════════════════════════════════════
// BOOT
// ═══════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {
  loadCfg();
  checkHealth();
  loadMem();
  setInterval(checkHealth, 22000);
  setInterval(loadMem, 14000);
  g('inp').focus();
  g('cfgTemp').addEventListener('input', function() {
    const v = parseFloat(this.value).toFixed(2);
    g('tDisp').textContent = v;
    g('tDisp2').textContent = v;
  });
});

// ═══════════════════════════════════════════════════════
// SIDEBAR
// ═══════════════════════════════════════════════════════
function toggleSb() { g('g').classList.toggle('collapsed'); }

function sbTab(t) {
  ['Info','Files','Hist'].forEach(x => {
    g('st'+x).classList.toggle('on', x.toLowerCase()===t);
    g('sp'+x).classList.toggle('on', x.toLowerCase()===t);
  });
  if (t==='files') loadFiles();
  if (t==='hist')  loadSess();
}

async function loadFiles() {
  const el = g('fileTree');
  try {
    const files = await api('/api/files/list');
    el.innerHTML = files.map(f =>
      `<div class="ftr" onclick="useFile(${JSON.stringify(f.path)})">
        <span class="ftico">${f.is_dir?'▸':'·'}</span>
        <span>${esc(f.name)}</span>
       </div>`
    ).join('') || '<div style="padding:8px 11px;color:var(--t4);font-size:11px;font-family:var(--mono)">Empty</div>';
  } catch { el.innerHTML = '<div style="padding:8px;color:var(--red);font-size:11px">Error</div>'; }
}

function useFile(path) {
  if (!path.match(/\.(py|js|ts|html|css|json|md|txt|yaml|toml|cfg|ini)$/i)) return;
  g('inp').value = `Read file: ${path}`;
  g('inp').focus(); grow(g('inp'));
}

async function loadSess() {
  const el = g('sessList');
  try {
    const d = await api('/api/sessions');
    el.innerHTML = (d.sessions||[]).map(s =>
      `<div class="ftr"><span class="ftico">·</span><span>${esc(s)}</span></div>`
    ).join('') || '<div style="padding:8px 11px;color:var(--t4);font-size:11px;font-family:var(--mono)">No sessions</div>';
  } catch { el.innerHTML = ''; }
}

// ═══════════════════════════════════════════════════════
// MODE
// ═══════════════════════════════════════════════════════
function setMode(m) {
  mode = m;
  document.querySelectorAll('.mb').forEach(b => b.classList.toggle('on', b.dataset.m===m));
  g('mPip').className = 'mpip' + (m!=='chat'?' '+m:'');
  g('mLbl').textContent = m;
}

// ═══════════════════════════════════════════════════════
// HEALTH & CONFIG
// ═══════════════════════════════════════════════════════
async function checkHealth() {
  try {
    const d = await api('/api/health');
    const ok = d.status === 'ok';
    setLive(ok?'on':'off');
    const el = g('sbSt');
    el.textContent = ok ? 'online' : 'offline';
    el.className = 'kv_ ' + (ok?'on':'off');
  } catch {
    setLive('off');
    const el = g('sbSt'); el.textContent='error'; el.className='kv_ off';
  }
}
function setLive(cls) { const d=g('liveDot'); if(d) d.className='mpill-dot '+cls; }

async function loadCfg() {
  try {
    cfg = await api('/api/config');
    const mdl = cfg.model_name || '—';
    const url = (cfg.base_url||'').replace(/^https?:\/\//,'');
    setText('hMdl', mdl);
    setText('sbMdl', mdl);
    setText('sbUrl', url);
    sv('cfgUrl', cfg.base_url || 'http://localhost:11434');
    sv('cfgModel', cfg.model_name || 'gemma3-4b');
    sv('cfgSteps', cfg.max_steps || 30);
    sv('cfgTokens', cfg.max_tokens || 4096);
    const t = parseFloat(cfg.temperature || 0.2).toFixed(2);
    g('cfgTemp').value = t;
    g('tDisp').textContent = g('tDisp2').textContent = t;
    g('pathInfo').innerHTML =
      `<b>Home</b> &nbsp; ${esc(cfg._home||'~/.devnet')}<br/>`+
      `<b>Models</b> &nbsp; ${esc(cfg._models_dir||'~/.devnet/models')}`;
  } catch {}
}

// ═══════════════════════════════════════════════════════
// PANELS
// ═══════════════════════════════════════════════════════
function openPanel(name) {
  g('ov').classList.add('open');
  ['panSettings','panModels'].forEach(p => g(p).style.display='none');
  const map = {settings:'panSettings', models:'panModels'};
  if (map[name]) g(map[name]).style.display = 'block';
  if (name==='models') loadModels();
}
function closeAll() { g('ov').classList.remove('open'); }
function ovBg(e) { if(e.target===g('ov')) closeAll(); }

// ═══════════════════════════════════════════════════════
// MODELS
// ═══════════════════════════════════════════════════════
async function loadModels() {
  const el = g('modelList');
  el.innerHTML = '<div style="color:var(--t3);padding:14px;text-align:center;font-family:var(--mono);font-size:11px">Loading…</div>';
  try {
    const models = await api('/api/models');
    if (!models.length) { el.innerHTML='<div style="padding:14px;color:var(--t3);text-align:center">No models found</div>'; return; }
    const groups = [
      ['Downloaded / Local', m => m.downloaded || m.tags?.includes('local')],
      ['Coding',             m => m.tags?.includes('coding')],
      ['General / Chat',     m => m.tags?.includes('general')||m.tags?.includes('chat')],
      ['Reasoning / Math',   m => m.tags?.includes('reasoning')||m.tags?.includes('math')],
      ['Multimodal',         m => m.tags?.includes('multimodal')],
      ['Other',              ()=>true],
    ];
    const seen = new Set();
    let html = '';
    for (const [lbl, fn] of groups) {
      const grp = models.filter(m => !seen.has(m.name) && fn(m));
      if (!grp.length) continue;
      html += `<div class="mghdr">${lbl}</div>`;
      for (const m of grp) {
        seen.add(m.name);
        const tags = [
          m.downloaded  ? '<span class="mtag dl">✓ downloaded</span>' : '<span class="mtag ndl">not local</span>',
          m.registered  ? '<span class="mtag reg">✓ in ollama</span>'  : '',
          m.recommended ? '<span class="mtag rec">★ recommended</span>' : '',
          `<span class="mtag">${m.size_gb}GB</span>`,
          `<span class="mtag">${m.speed_toks||'?'}</span>`,
          ...(m.tags||[]).slice(0,2).map(t=>`<span class="mtag">${t}</span>`),
        ].filter(Boolean).join('');
        html += `<div class="mc${m.active?' active':''}">
          ${m.active?'<div class="mcat">ACTIVE</div>':''}
          <div class="mcn">${esc(m.name)}</div>
          <div class="mcd">${esc(m.description||'')}</div>
          <div class="mctags">${tags}</div>
          <div class="macts">
            <button class="mbtn use" onclick="useModel('${m.name}')">Use model</button>
            ${m.hf_url&&m.repo!=='local'?`<a href="${m.hf_url}" target="_blank" class="mbtn">HuggingFace ↗</a>`:''}
          </div>
        </div>`;
      }
    }
    el.innerHTML = html;
  } catch(e) {
    el.innerHTML = `<div style="padding:14px;color:var(--red);font-family:var(--mono);font-size:11px">Error: ${esc(e.message)}</div>`;
  }
}

async function useModel(name) {
  try {
    const d = await api('/api/model/switch',{method:'POST',body:{name}});
    d.ok ? (toast('Switched to '+name,'ok'), loadCfg(), loadModels(), checkHealth())
         :  toast('Error: '+d.msg,'err');
  } catch(e) { toast('Failed: '+e.message,'err'); }
}

// ═══════════════════════════════════════════════════════
// SETTINGS
// ═══════════════════════════════════════════════════════
async function saveSettings() {
  try {
    await api('/api/config/save',{method:'POST',body:{
      base_url:    g('cfgUrl').value.trim(),
      model_name:  g('cfgModel').value.trim(),
      max_steps:  +g('cfgSteps').value||30,
      max_tokens: +g('cfgTokens').value||4096,
      temperature:+g('cfgTemp').value||0.2,
    }});
    toast('Settings saved','ok'); closeAll(); loadCfg(); checkHealth();
  } catch(e) { toast('Failed: '+e.message,'err'); }
}

// ═══════════════════════════════════════════════════════
// MEMORY
// ═══════════════════════════════════════════════════════
async function loadMem() {
  try {
    const d = await api('/api/memory');
    const keys = Object.keys(d);
    g('memList').innerHTML = keys.length
      ? keys.map(k=>`<div class="me"><b>${esc(k)}</b>: ${esc(String(d[k]).slice(0,48))}</div>`).join('')
      : '<span class="me-empty">empty</span>';
  } catch {}
}
async function clearMem() {
  await api('/api/memory/clear',{method:'POST',body:{}});
  loadMem(); toast('Memory cleared');
}

// ═══════════════════════════════════════════════════════
// SEND — SSE
// ═══════════════════════════════════════════════════════
async function send() {
  if (busy) return;
  const inp = g('inp');
  const msg = inp.value.trim();
  if (!msg) return;
  inp.value=''; grow(inp); killWelcome();

  appendUser(msg);
  setBusy(true); setLive('busy');

  const mid  = 'am'+Date.now();
  const shell = appendShell(mid);
  const bodyEl = shell.querySelector('.mb');
  const tclEl  = shell.querySelector('.tcl');
  const srEl   = shell.querySelector('.sr');

  let fullTxt='', tcCtr=0, steps=0, allTcs=[];

  try {
    const resp = await fetch('/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({message:msg, mode}),
    });
    if (!resp.ok||!resp.body) throw new Error('HTTP '+resp.status);

    const reader=resp.body.getReader(), dec=new TextDecoder();
    let buf='';

    while(true) {
      const {value,done}=await reader.read();
      if(done) break;
      buf+=dec.decode(value,{stream:true});
      const lines=buf.split('\n');
      buf=lines.pop();
      for(const line of lines) {
        if(!line.startsWith('data: ')) continue;
        const raw=line.slice(6).trim();
        if(raw==='[CLOSE]') break;
        let ev; try{ev=JSON.parse(raw);}catch{continue;}
        switch(ev.type) {
          case 'token':
            fullTxt+=ev.token;
            bodyEl.innerHTML=renderMd(fullTxt)+'<span class="cr"></span>';
            scrollFeed(); break;
          case 'step':
            steps=ev.step; break;
          case 'tool_call': {
            const id=`${mid}_tc${tcCtr++}`;
            const tc={id,tool:ev.tool,args:ev.args,done:false};
            allTcs.push(tc); addTc(tclEl,tc); scrollFeed(); break;
          }
          case 'tool_result': {
            const tc=[...allTcs].reverse().find(t=>t.tool===ev.tool&&!t.done);
            if(tc){tc.done=true;tc.result=ev.result;resolveTc(tc,ev.result);}
            break;
          }
          case 'status':
            bodyEl.innerHTML=`<em style="color:var(--t3)">${esc(ev.msg)}</em>`;
            break;
          case 'done':
            fullTxt=ev.response||fullTxt;
            bodyEl.innerHTML=renderMd(fullTxt);
            if(steps>0||allTcs.length>0) {
              srEl.innerHTML=
                `<span class="stag">${steps} step${steps!==1?'s':''}</span>`+
                `<span class="stag">${allTcs.length} tool call${allTcs.length!==1?'s':''}</span>`;
            }
            turns++;setText('sbTurns',String(turns));
            loadMem(); scrollFeed(); break;
          case 'error':
            bodyEl.innerHTML=`<span style="color:var(--red)">⚠ ${esc(ev.error)}</span>`; break;
        }
      }
    }
  } catch(e) {
    bodyEl.innerHTML=`<span style="color:var(--red)">Connection error: ${esc(e.message)}</span>`;
  } finally {
    bodyEl.querySelector('.cr')?.remove();
    setBusy(false); setLive('on'); scrollFeed();
  }
}

// ═══════════════════════════════════════════════════════
// DOM BUILDERS
// ═══════════════════════════════════════════════════════
function killWelcome() { g('welcome')?.remove(); }

function appendUser(text) {
  const el=mk('div','msg');
  el.innerHTML=`<div class="mh"><div class="av av-u">you</div><span class="mwho">You</span><span class="mts">${ts()}</span></div><div class="mb">${renderMd(text)}</div>`;
  g('feed').appendChild(el); scrollFeed();
}

function appendShell(id) {
  const el=mk('div','msg'); el.id=id;
  el.innerHTML=`<div class="mh"><div class="av av-a">dn</div><span class="mwho">DevNet</span><span class="mts">${ts()}</span></div><div class="sr"></div><div class="tcl"></div><div class="mb"><span class="cr"></span></div>`;
  g('feed').appendChild(el); scrollFeed(); return el;
}

function addTc(container, tc) {
  const el=mk('div','tc'); el.id=tc.id;
  el.innerHTML=`<div class="tch" onclick="toggleTc('${tc.id}')">
    <div class="tcb_ pend" id="b_${tc.id}">…</div>
    <span class="tct" id="n_${tc.id}">${esc(tc.tool)}</span>
    <span class="tcs_" id="s_${tc.id}">calling</span>
    <span class="tcarr" id="a_${tc.id}">▶</span>
  </div>
  <div class="tcbody" id="bd_${tc.id}"><span class="tcsec">── args</span>\n${JSON.stringify(tc.args||{},null,2)}</div>`;
  container.appendChild(el);
}

function resolveTc(tc, result) {
  const err = String(result).startsWith('[ERROR]');
  const s   = err?'er':'ok';
  const b=g('b_'+tc.id); if(b){b.className='tcb_ '+s;b.textContent=err?'✗':'✓';}
  const n=g('n_'+tc.id); if(n) n.className='tct '+s;
  const st=g('s_'+tc.id); if(st) st.textContent=err?'error':'done';
  const bd=g('bd_'+tc.id); if(bd) bd.textContent+='\n\n── result\n'+result;
}

function toggleTc(id) {
  const el=g(id); if(!el) return;
  el.querySelector('.tcbody')?.classList.toggle('open');
  el.querySelector('.tcarr')?.classList.toggle('open');
}

// ═══════════════════════════════════════════════════════
// MARKDOWN
// ═══════════════════════════════════════════════════════
function renderMd(text) {
  if(!text) return '';
  text=text.replace(/```(\w*)\n?([\s\S]*?)```/g,(_,lang,code)=>{
    const id=cbIdx++;
    return `<div class="cb"><div class="cbt"><span class="cbl">${lang||'code'}</span><button class="cbc" onclick="cpCode(this,${id})">copy</button></div><pre><code id="cb_${id}">${esc(code.trim())}</code></pre></div>`;
  });
  text=text.replace(/`([^`\n]+)`/g,'<code>$1</code>');
  text=text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
  text=text.replace(/^#{1,3}\s+(.+)$/gm,'<p><strong>$1</strong></p>');
  text=text.replace(/^[-*]\s+(.+)$/gm,'<li>$1</li>');
  if(text.includes('<li>')) text=text.replace(/(<li>.*<\/li>)/gs,'<ul>$1</ul>');
  const lines=text.split('\n'), out=[], para=[];
  for(const ln of lines){
    if(ln.includes('class="cb"')||ln.includes('<ul>')){
      if(para.length){out.push('<p>'+para.join(' ')+'</p>');para.length=0;}
      out.push(ln);
    } else if(!ln.trim()){
      if(para.length){out.push('<p>'+para.join(' ')+'</p>');para.length=0;}
    } else { para.push(ln); }
  }
  if(para.length) out.push('<p>'+para.join(' ')+'</p>');
  return out.join('');
}

function cpCode(btn, idx) {
  navigator.clipboard.writeText(g('cb_'+idx)?.textContent||'')
    .then(()=>{btn.textContent='copied!';setTimeout(()=>btn.textContent='copy',1400);});
}

// ═══════════════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════════════
function scrollFeed() { const f=g('feed'); f.scrollTop=f.scrollHeight; }
function setBusy(b) { busy=b; g('sendBtn').disabled=b; }
function onKey(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();} }
function grow(t) { t.style.height='auto'; t.style.height=Math.min(t.scrollHeight,150)+'px'; }
function ts() { return new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
function g(id) { return document.getElementById(id); }
function mk(tag,cls) { const e=document.createElement(tag); if(cls)e.className=cls; return e; }
function setText(id,v) { const e=g(id); if(e)e.textContent=v; }
function sv(id,v) { const e=g(id); if(e)e.value=v; }
function chip(el) { g('inp').value=el.textContent; g('inp').focus(); grow(g('inp')); }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

async function newChat() {
  await api('/api/reset',{method:'POST',body:{}});
  g('feed').innerHTML=`<div class="wlc" id="welcome">
    <div class="wico">◈</div>
    <div class="wh">DevNet <em>Agent</em></div>
    <p class="wp">Conversation cleared.</p>
  </div>`;
  turns=0; setText('sbTurns','0'); toast('New conversation');
}

function toast(msg,type='') {
  const t=g('toast');
  t.textContent=msg; t.className='toast show'+(type?' '+type:'');
  setTimeout(()=>t.className='toast'+(type?' '+type:''),2200);
}

async function api(url,opts={}) {
  const {method='GET',body,timeout=30000}=opts;
  const ctrl=new AbortController();
  const tid=setTimeout(()=>ctrl.abort(),timeout);
  try {
    const res=await fetch(url,{
      method,
      headers: body?{'Content-Type':'application/json'}:{},
      body: body?JSON.stringify(body):undefined,
      signal: ctrl.signal,
    });
    return await res.json();
  } finally { clearTimeout(tid); }
}
</script>
</body>
</html>
